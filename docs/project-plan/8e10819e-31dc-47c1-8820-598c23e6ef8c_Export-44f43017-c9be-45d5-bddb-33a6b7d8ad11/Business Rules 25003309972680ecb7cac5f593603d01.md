# Business Rules

# Calculation Transparency Rule (CTR)

Whenever an answer contains a number derived from **more than one clause/table** (even if they’re in the **same** document), the system must:

1. **Show the full expression**, not just the total.
2. **Show every operand** with its own **evidence chip(s)**.
3. **Link each operand** to the **exact span/cell** (doc → page → bbox or cell r/c).
4. **Evaluate & verify** the math (and units) before displaying; otherwise **block** and send to HIL.
5. **Scope everything As-Of a date** (so the right versions are used).

No sources → no operand → no total. Period.

## What this looks like in the UI

**Answer (headline):**

**Total rent (Oct 2020): $15,342.17**  *(As-Of: 2020-10-01)*

**Show work** (always visible; collapsible for space, but **on** by default):

- Base Rent — **$10,000.00** 🟦 `Lease • p12 • §2.1(a)`
- CAM — **$4,231.17** 🟦 `Amend. 1 • p3 • r3c2`
- Taxes — **$1,111.00** 🟦 `Lease • p18 • Exhibit B`
- Credits — **$0.00** 🟦 `Amend. 2 • p4 • §5(b)`

**Formula trace:**

`total = base_rent + cam + taxes − credits` → `= 10000.00 + 4231.17 + 1111.00 − 0.00 = 15342.17` ✓ Verified

Each chip opens the correct tab and highlights the exact span/cell. Shift+click opens Side-by-Side.

---

## Minimal payload your agent must return (expression tree)

```json
{
  "as_of": "2020-10-01",
  "unit": "USD",
  "precision": 2,
  "expression": {
    "op": "sum",
    "children": [
      {
        "label": "base_rent",
        "value": 10000.00,
        "unit": "USD",
        "evidence": [
          {"doc":"LEASE_2019.pdf","page":12,"section":"§2.1(a)","bbox":[...]}
        ]
      },
      {
        "label": "cam",
        "value": 4231.17,
        "unit": "USD",
        "evidence": [
          {"doc":"AMEND_1.pdf","page":3,"table":{"row":3,"col":2,"title":"CAM Schedule"},"bbox":[...]}
        ]
      },
      {
        "label": "taxes",
        "value": 1111.00,
        "unit": "USD",
        "evidence": [
          {"doc":"LEASE_2019.pdf","page":18,"section":"Exhibit B","bbox":[...]}
        ]
      },
      {
        "label": "credits",
        "op": "negate",
        "child": {
          "value": 0.00,
          "unit": "USD",
          "evidence": [
            {"doc":"AMEND_2.pdf","page":4,"section":"§5(b)","bbox":[...]}
          ]
        }
      }
    ]
  }
}

```

- The UI renders the tree as the “Show work” list + formula trace.
- Each operand has **its own evidence array** (multi-doc supported).
- If an operand itself is computed (e.g., proration), it’s another subtree (`op:"mul"` with factors and their evidence).

---

## Validator (must pass before display)

- **Arithmetic check:** evaluate the tree exactly (no floating-point surprises; use decimal).
- **Unit consistency:** normalize units/currencies; reject mixed units unless conversion evidence is provided.
- **Table checks:** if value comes from a table, confirm the cell exists and (optionally) run checksum/typing (✅/⚠️).
- **As-Of:** fetch ClauseVersions valid on the date; if multiple candidates → flag conflict, block display, open HIL task.
- **Rounding policy:** round **only** at display; keep internal math at high precision.

If any operand is missing evidence or fails validation → **don’t show the total**. Display:

> Blocked: missing/invalid evidence for CAM. Send to Review →
> 

---

## Edge cases (baked into CTR)

- **Two sources in the same doc** (e.g., rate in §2.1(a) and area in Exhibit A): show both operands with chips; compute `rate × area`.
- **Proration** (mid-month start): show `daily_rate × billable_days` with evidence for both (clause + calendar rule).
- **Percentage rent**: show `rate × (sales − breakpoint)` with chips for each factor.
- **Amendments**: As-Of ensures the correct version of each operand (A1/B1 vs A2/B1) without manual tab-picking.
- **Credits/abatements**: explicit negative line with its own source (don’t silently net).

---

## Implementation checklist (fast path)