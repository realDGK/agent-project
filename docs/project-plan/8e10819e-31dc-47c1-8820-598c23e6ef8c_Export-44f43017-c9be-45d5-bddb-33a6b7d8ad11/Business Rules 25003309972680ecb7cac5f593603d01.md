# Business Rules

# Calculation Transparency Rule (CTR)

Whenever an answer contains a number derived from **more than one clause/table** (even if theyâ€™re in the **same** document), the system must:

1. **Show the full expression**, not just the total.
2. **Show every operand** with its own **evidence chip(s)**.
3. **Link each operand** to the **exact span/cell** (doc â†’ page â†’ bbox or cell r/c).
4. **Evaluate & verify** the math (and units) before displaying; otherwise **block** and send to HIL.
5. **Scope everything As-Of a date** (so the right versions are used).

No sources â†’ no operand â†’ no total. Period.

## What this looks like in the UI

**Answer (headline):**

**Total rent (Oct 2020): $15,342.17**  *(As-Of: 2020-10-01)*

**Show work** (always visible; collapsible for space, but **on** by default):

- Base Rent â€” **$10,000.00** ðŸŸ¦ `Lease â€¢ p12 â€¢ Â§2.1(a)`
- CAM â€” **$4,231.17** ðŸŸ¦ `Amend. 1 â€¢ p3 â€¢ r3c2`
- Taxes â€” **$1,111.00** ðŸŸ¦ `Lease â€¢ p18 â€¢ Exhibit B`
- Credits â€” **$0.00** ðŸŸ¦ `Amend. 2 â€¢ p4 â€¢ Â§5(b)`

**Formula trace:**

`total = base_rent + cam + taxes âˆ’ credits` â†’ `= 10000.00 + 4231.17 + 1111.00 âˆ’ 0.00 = 15342.17` âœ“ Verified

Each chip opens the correct tab and highlights the exact span/cell. Shift+click opens Side-by-Side.

---

## Minimal payload your agent must return (expression tree)

```json
{
  "as_of": "2020-10-01",
  "unit": "USD",
  "precision": 2,
  "expression": {
    "op": "sum",
    "children": [
      {
        "label": "base_rent",
        "value": 10000.00,
        "unit": "USD",
        "evidence": [
          {"doc":"LEASE_2019.pdf","page":12,"section":"Â§2.1(a)","bbox":[...]}
        ]
      },
      {
        "label": "cam",
        "value": 4231.17,
        "unit": "USD",
        "evidence": [
          {"doc":"AMEND_1.pdf","page":3,"table":{"row":3,"col":2,"title":"CAM Schedule"},"bbox":[...]}
        ]
      },
      {
        "label": "taxes",
        "value": 1111.00,
        "unit": "USD",
        "evidence": [
          {"doc":"LEASE_2019.pdf","page":18,"section":"Exhibit B","bbox":[...]}
        ]
      },
      {
        "label": "credits",
        "op": "negate",
        "child": {
          "value": 0.00,
          "unit": "USD",
          "evidence": [
            {"doc":"AMEND_2.pdf","page":4,"section":"Â§5(b)","bbox":[...]}
          ]
        }
      }
    ]
  }
}

```

- The UI renders the tree as the â€œShow workâ€ list + formula trace.
- Each operand has **its own evidence array** (multi-doc supported).
- If an operand itself is computed (e.g., proration), itâ€™s another subtree (`op:"mul"` with factors and their evidence).

---

## Validator (must pass before display)

- **Arithmetic check:** evaluate the tree exactly (no floating-point surprises; use decimal).
- **Unit consistency:** normalize units/currencies; reject mixed units unless conversion evidence is provided.
- **Table checks:** if value comes from a table, confirm the cell exists and (optionally) run checksum/typing (âœ…/âš ï¸).
- **As-Of:** fetch ClauseVersions valid on the date; if multiple candidates â†’ flag conflict, block display, open HIL task.
- **Rounding policy:** round **only** at display; keep internal math at high precision.

If any operand is missing evidence or fails validation â†’ **donâ€™t show the total**. Display:

> Blocked: missing/invalid evidence for CAM. Send to Review â†’
> 

---

## Edge cases (baked into CTR)

- **Two sources in the same doc** (e.g., rate in Â§2.1(a) and area in Exhibit A): show both operands with chips; compute `rate Ã— area`.
- **Proration** (mid-month start): show `daily_rate Ã— billable_days` with evidence for both (clause + calendar rule).
- **Percentage rent**: show `rate Ã— (sales âˆ’ breakpoint)` with chips for each factor.
- **Amendments**: As-Of ensures the correct version of each operand (A1/B1 vs A2/B1) without manual tab-picking.
- **Credits/abatements**: explicit negative line with its own source (donâ€™t silently net).

---

## Implementation checklist (fast path)