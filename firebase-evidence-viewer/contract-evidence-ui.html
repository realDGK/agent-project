<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="2.1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Contract Evidence UI v2.1.0 - Lawyer Grade</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            overflow: hidden;
        }

        /* Main Layout - 3 Panes */
        .main-container {
            display: flex;
            height: 100vh;
            gap: 1px;
            background: #e2e8f0;
        }

        .pane {
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-window {
            flex: 1;
            min-width: 400px;
            max-width: 500px;
        }

        .source-reading-pane {
            flex: 2;
            min-width: 600px;
        }

        .side-by-side-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .sxs-container {
            width: 95%;
            height: 95%;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .sxs-content {
            display: flex;
            flex: 1;
            gap: 1px;
            background: #e2e8f0;
        }

        .sxs-pane {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
        }

        /* Pane Headers */
        .pane-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 60px;
        }

        .pane-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .pane-subtitle {
            font-size: 14px;
            color: #64748b;
        }

        /* Chat Window Styles */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .message {
            margin-bottom: 24px;
        }

        .message.user {
            text-align: right;
        }

        .message.assistant .content {
            background: #f1f5f9;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .message.user .content {
            background: #3b82f6;
            color: white;
            padding: 16px;
            border-radius: 12px;
            display: inline-block;
            max-width: 80%;
        }

        /* Evidence Chips */
        .evidence-chips {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .evidence-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            font-size: 12px;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .evidence-chip:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
            transform: translateY(-1px);
        }

        .evidence-chip.verified {
            border-color: #22c55e;
            background: #f0fdf4;
            color: #166534;
        }

        .evidence-chip .confidence-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .confidence-high { background-color: #22c55e; }
        .confidence-medium { background-color: #f59e0b; }
        .confidence-low { background-color: #ef4444; }

        /* Source Reading Pane */
        .tab-bar {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            color: #64748b;
            transition: all 0.2s;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: white;
        }

        .tab:hover:not(.active) {
            color: #1e293b;
            background: #f1f5f9;
        }

        .tab.conformed {
            font-weight: 600;
            background: #fef3c7;
            color: #92400e;
        }

        .tab.conformed.active {
            background: #fbbf24;
            color: #78350f;
        }

        .as-of-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .as-of-date {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }


        /* Document Viewer */
        .document-viewer {
            flex: 1;
            background: #f8fafc;
            position: relative;
            overflow: hidden;
        }

        .viewer-controls {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .viewer-controls button {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .viewer-controls button:hover {
            background: #f9fafb;
        }

        .document-canvas-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .document-page {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-bottom: 20px;
        }

        .highlight-overlay {
            position: absolute;
            background: rgba(255, 235, 59, 0.4);
            border: 2px solid rgba(255, 193, 7, 0.8);
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .highlight-overlay.flash {
            animation: flash 0.6s ease-in-out;
        }

        @keyframes flash {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

        /* Calculation Breakdown */
        .calculation-breakdown {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .breakdown-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .breakdown-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
        }

        .breakdown-line.total {
            border-top: 1px solid #d1d5db;
            padding-top: 8px;
            font-weight: 600;
        }

        .formula-trace {
            margin-top: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            color: #64748b;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .verified-badge {
            color: #22c55e;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-badge {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 6px;
            font-weight: 600;
        }

        .status-badge.verified {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.warn {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.blocked {
            background: #fecaca;
            color: #991b1b;
        }

        .status-badge.na {
            background: #f1f5f9;
            color: #64748b;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #22c55e;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 3000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .blocked-calculation {
            padding: 16px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            margin-top: 16px;
        }

        .blocked-calculation .title {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* Side-by-Side Controls */
        .sxs-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .sxs-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            margin-left: auto;
        }

        .sxs-close:hover {
            color: #1e293b;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .chat-window {
                min-width: 350px;
                max-width: 400px;
            }
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .chat-window {
                max-width: none;
                flex: 0 0 200px;
            }
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .flex { display: flex !important; }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 4px 0;
            z-index: 1001;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .context-menu-item:hover {
            background: #f1f5f9;
        }
    </style>
</head>
<body>
    <!-- Main 3-Pane Layout -->
    <div class="main-container">
        <!-- Chat Window (Left Pane) -->
        <div class="pane chat-window">
            <div class="pane-header">
                <div>
                    <div class="pane-title">Contract Analysis</div>
                    <div class="pane-subtitle">Ask questions about your contracts</div>
                </div>
            </div>
            
            <div class="chat-history" id="chatHistory">
                <!-- Sample conversation -->
                <div class="message user">
                    <div class="content">
                        What is the current base rent for the Lathrop property as of October 2020?
                    </div>
                </div>
                
                <div class="message assistant">
                    <div class="content">
                        <p>Total rent as of October 2020: <strong>$15,342.17</strong></p>
                        
                        <div class="calculation-breakdown">
                            <div class="breakdown-title">Calculation Breakdown</div>
                            <div class="breakdown-line" data-testid="breakdown-row">
                                <span>Base Rent <span class="status-badge verified">✓</span></span>
                                <span>$10,000.00</span>
                            </div>
                            <div class="breakdown-line" data-testid="breakdown-row">
                                <span>CAM Charges <span class="status-badge verified">✓</span></span>
                                <span>$4,231.17</span>
                            </div>
                            <div class="breakdown-line" data-testid="breakdown-row">
                                <span>Property Taxes <span class="status-badge verified">✓</span></span>
                                <span>$1,111.00</span>
                            </div>
                            <div class="breakdown-line" data-testid="breakdown-row">
                                <span>Credits <span class="status-badge na">—</span></span>
                                <span>$0.00</span>
                            </div>
                            <div class="breakdown-line total" data-testid="breakdown-row">
                                <span>Total <span class="status-badge verified">✓</span></span>
                                <span>$15,342.17</span>
                            </div>
                            
                            <div class="formula-trace">
                                = 10000.00 + 4231.17 + 1111.00 + 0.00 = 15342.17 <span class="verified-badge">✓ Verified</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="evidence-chips">
                        <a href="/doc/abc123def456lease2019?page=12&bbox=100,520,420,560&field=base_rent&asof=2020-10-01" 
                           class="evidence-chip verified" 
                           data-testid="evidence-chip"
                           data-doc="LEASE_2019.pdf" 
                           data-sha256="abc123def456lease2019" 
                           data-page="12" 
                           data-bbox="100,520,420,560"
                           data-field="base_rent"
                           data-section="§2.1(a)">
                            <div class="confidence-indicator confidence-high"></div>
                            Lease 2019 • p12 • §2.1(a)
                        </a>
                        <a href="/doc/def789ghi012amend1?page=3&bbox=210,320,280,340&field=cam_charges&asof=2020-10-01" 
                           class="evidence-chip verified" 
                           data-testid="evidence-chip"
                           data-doc="AMEND_1.pdf" 
                           data-sha256="def789ghi012amend1" 
                           data-page="3" 
                           data-bbox="210,320,280,340"
                           data-field="cam_charges"
                           data-section="r3c2">
                            <div class="confidence-indicator confidence-high"></div>
                            Amend. 1 • p3 • r3c2
                        </a>
                        <a href="/doc/abc123def456lease2019?page=18&bbox=140,200,390,230&field=property_taxes&asof=2020-10-01" 
                           class="evidence-chip verified" 
                           data-testid="evidence-chip"
                           data-doc="LEASE_2019.pdf" 
                           data-sha256="abc123def456lease2019" 
                           data-page="18" 
                           data-bbox="140,200,390,230"
                           data-field="property_taxes"
                           data-section="Exhibit B">
                            <div class="confidence-indicator confidence-medium"></div>
                            Lease 2019 • p18 • Exhibit B
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <textarea class="chat-input" placeholder="Ask about your contracts..." id="chatInput"></textarea>
            </div>
        </div>

        <!-- Source Reading Pane (Center) -->
        <div class="pane source-reading-pane">
            <div class="pane-header">
                <div>
                    <div class="pane-title">Source Documents</div>
                </div>
                <div class="as-of-controls">
                    <label for="asOfDate">As-Of:</label>
                    <input type="date" class="as-of-date" id="asOfDate" value="2020-10-01" data-testid="asof-date">
                </div>
            </div>
            
            <div class="tab-bar" id="tabBar">
                <div class="tab conformed active" data-tab="conformed" data-testid="tab-conformed">Conformed (As-Of 2020-10-01)</div>
                <div class="tab" data-tab="lease2019" data-testid="tab-document">LEASE_2019.pdf</div>
                <div class="tab" data-tab="amend1" data-testid="tab-document">AMEND_1.pdf</div>
            </div>
            
            <div class="viewer-controls">
                <button onclick="zoomOut()">Zoom Out</button>
                <button onclick="zoomIn()">Zoom In</button>
                <button onclick="toggleTextLayer()">Toggle Text</button>
                <button onclick="openFullPDF()">Full PDF</button>
                <button onclick="findInDoc()">Find</button>
                <button onclick="expandCurrentView()" data-testid="fullview-toggle" title="Expand Current View (F)">Expand</button>
                <button onclick="prevEvidence()" data-testid="prev-evidence">← Prev Evidence</button>
                <button onclick="nextEvidence()" data-testid="next-evidence">Next Evidence →</button>
            </div>
            
            <div class="document-viewer">
                <div class="document-canvas-container" id="documentCanvas">
                    <div class="document-page" style="width: 600px; height: 800px; background: white;">
                        <!-- Mock document page -->
                        <div style="padding: 40px; font-family: serif; line-height: 1.6;">
                            <h2 style="text-align: center; margin-bottom: 30px;">COMMERCIAL LEASE AGREEMENT</h2>
                            
                            <p><strong>Section 2.1(a) - Base Rent</strong></p>
                            <p style="background: rgba(255, 235, 59, 0.3); padding: 8px; border: 2px solid rgba(255, 193, 7, 0.8);">
                                Tenant shall pay to Landlord as base rent the sum of <strong>$10,000.00</strong> per month, payable in advance on the first day of each calendar month.
                            </p>
                            
                            <p style="margin-top: 30px;"><strong>Section 3.2 - Additional Charges</strong></p>
                            <p>In addition to base rent, Tenant shall pay all applicable taxes, insurance, and common area maintenance charges as set forth in Exhibit B attached hereto.</p>
                            
                            <div style="margin-top: 40px;">
                                <h3>Exhibit B - Operating Expenses</h3>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                    <tr style="background: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Expense Type</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Monthly Amount</th>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">Property Taxes</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right; background: rgba(255, 235, 59, 0.3);">$1,111.00</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">Insurance</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$456.00</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">CAM</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$2,789.00</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Side-by-Side Overlay -->
    <div class="side-by-side-overlay" id="sxsOverlay">
        <div class="sxs-container">
            <div class="sxs-header">
                <div class="pane-title">Side-by-Side Comparison</div>
                <button class="sxs-close" onclick="closeSxS()" data-testid="open-sxs">&times;</button>
            </div>
            
            <div class="sxs-content">
                <div class="sxs-pane">
                    <div class="pane-header">
                        <div>
                            <div class="pane-title">Conformed (As-Of 2020-10-01)</div>
                            <div class="pane-subtitle">Current state with amendments</div>
                        </div>
                        <input type="date" class="as-of-date" value="2020-10-01">
                    </div>
                    <div class="document-viewer">
                        <div class="document-canvas-container">
                            <div class="document-page" style="width: 500px; height: 650px; background: white; padding: 30px;">
                                <h3>Current Rent Terms (As-Of Oct 1, 2020)</h3>
                                <p style="background: rgba(34, 197, 94, 0.2); padding: 12px; border-left: 4px solid #22c55e;">
                                    <strong>Base Rent:</strong> $10,000.00/month<br>
                                    <strong>CAM:</strong> $4,231.17/month<br>
                                    <strong>Taxes:</strong> $1,111.00/month<br>
                                    <strong>Total:</strong> $15,342.17/month
                                </p>
                                <p style="margin-top: 20px; font-size: 14px; color: #64748b;">
                                    ↳ Updated by Amendment 1, effective June 1, 2019<br>
                                    ↳ CAM increase per Amendment 2, effective October 1, 2020
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sxs-pane">
                    <div class="pane-header">
                        <div>
                            <div class="pane-title">AMEND_1.pdf</div>
                            <div class="pane-subtitle">Source Amendment</div>
                        </div>
                    </div>
                    <div class="document-viewer">
                        <div class="document-canvas-container">
                            <div class="document-page" style="width: 500px; height: 650px; background: white; padding: 30px;">
                                <h3>First Amendment to Lease</h3>
                                <p><strong>Effective Date:</strong> June 1, 2019</p>
                                
                                <p style="margin-top: 20px;"><strong>Section 3 - CAM Charges Amendment</strong></p>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                    <tr style="background: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Item</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">Base CAM</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$2,789.00</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">Escalation</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; background: rgba(255, 235, 59, 0.3);">$1,442.17</td>
                                    </tr>
                                    <tr style="font-weight: bold;">
                                        <td style="border: 1px solid #ddd; padding: 8px;">Total CAM</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; background: rgba(255, 235, 59, 0.3);">$4,231.17</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu hidden" id="contextMenu">
        <button class="context-menu-item" onclick="copyDeepLink()">Copy Deep Link</button>
        <button class="context-menu-item" onclick="sendToReview()">Send to Review</button>
        <button class="context-menu-item" onclick="showEvidence()">Show Evidence</button>
    </div>

    <script>
        // Version and Cache Control
        const VERSION = '2.1.0';
        const BUILD_TIMESTAMP = new Date().toISOString();
        console.log(`Contract Evidence UI v${VERSION} - Build: ${BUILD_TIMESTAMP}`);
        
        // Global state
        let currentTab = 'conformed';
        let currentAsOfDate = '2020-10-01';
        let selectedEvidence = null;
        let sxsOpen = false;
        let fullViewOpen = false;

        // Mock document data
        const mockDocuments = {
            'lease2019': {
                title: 'LEASE_2019.pdf',
                content: `
                    <h2 style="text-align: center; margin-bottom: 30px;">ORIGINAL LEASE AGREEMENT - 2019</h2>
                    
                    <p><strong>Section 2.1(a) - Base Rent</strong></p>
                    <p style="background: rgba(255, 235, 59, 0.3); padding: 8px; border: 2px solid rgba(255, 193, 7, 0.8);">
                        Tenant shall pay to Landlord as base rent the sum of <strong>$8,500.00</strong> per month, payable in advance on the first day of each calendar month.
                    </p>
                    
                    <p style="margin-top: 30px;"><strong>Section 3.2 - Additional Charges</strong></p>
                    <p>In addition to base rent, Tenant shall pay all applicable taxes, insurance, and common area maintenance charges as set forth in Exhibit B attached hereto.</p>
                    
                    <div style="margin-top: 40px;">
                        <h3>Exhibit B - Operating Expenses (Original)</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <tr style="background: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Expense Type</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Monthly Amount</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Property Taxes</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$980.00</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">Insurance</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$456.00</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">CAM</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$2,100.00</td>
                            </tr>
                        </table>
                    </div>
                `
            },
            'amend1': {
                title: 'AMEND_1.pdf',
                content: `
                    <h2 style="text-align: center; margin-bottom: 30px;">FIRST AMENDMENT TO LEASE</h2>
                    <p><strong>Effective Date:</strong> June 1, 2019</p>
                    
                    <p style="margin-top: 20px;"><strong>Section 1 - Base Rent Increase</strong></p>
                    <p style="background: rgba(255, 235, 59, 0.3); padding: 8px; border: 2px solid rgba(255, 193, 7, 0.8);">
                        Effective June 1, 2019, Section 2.1(a) is hereby amended to increase base rent from $8,500.00 to <strong>$10,000.00</strong> per month.
                    </p>
                    
                    <p style="margin-top: 30px;"><strong>Section 2 - CAM Charges Amendment</strong></p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px;">Item</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">Base CAM</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">$2,789.00</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px; background: rgba(255, 235, 59, 0.3);">Escalation</td>
                            <td style="border: 1px solid #ddd; padding: 8px; background: rgba(255, 235, 59, 0.3);">$1,442.17</td>
                        </tr>
                        <tr style="font-weight: bold;">
                            <td style="border: 1px solid #ddd; padding: 8px;">Total CAM</td>
                            <td style="border: 1px solid #ddd; padding: 8px; background: rgba(255, 235, 59, 0.3);">$4,231.17</td>
                        </tr>
                    </table>
                `
            },
            'conformed': function(asOfDate) {
                // Generate content based on the as-of date
                const isBeforeAmendment = asOfDate < '2019-06-01';
                const baseRent = isBeforeAmendment ? '$8,500.00' : '$10,000.00';
                const cam = isBeforeAmendment ? '$2,100.00' : '$4,231.17';
                const total = isBeforeAmendment ? '$12,691.00' : '$15,342.17';
                const status = isBeforeAmendment ? 'Original terms in effect' : 'As amended';
                
                return {
                    title: 'Conformed Agreement',
                    content: `
                        <h2 style="text-align: center; margin-bottom: 30px;">CONFORMED LEASE AGREEMENT</h2>
                        <p style="text-align: center; color: #64748b; margin-bottom: 30px;">As of: <strong>${asOfDate}</strong> | Status: ${status}</p>
                        
                        <p><strong>Section 2.1(a) - Base Rent (${isBeforeAmendment ? 'Original' : 'Amended'})</strong></p>
                        <p style="background: rgba(34, 197, 94, 0.2); padding: 12px; border-left: 4px solid #22c55e;">
                            Tenant shall pay to Landlord as base rent the sum of <strong>${baseRent}</strong> per month, payable in advance on the first day of each calendar month.
                            ${!isBeforeAmendment ? '<br><em style="font-size: 12px; color: #64748b;">↳ Updated by Amendment 1, effective June 1, 2019</em>' : ''}
                        </p>
                        
                        <div style="margin-top: 40px;">
                            <h3>Operating Expenses (As of ${asOfDate})</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Expense Type</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Monthly Amount</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Source</th>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">Base Rent</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; background: rgba(255, 235, 59, 0.3);">${baseRent}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 11px;">${isBeforeAmendment ? 'Original Lease' : 'Amendment 1'}</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">Property Taxes</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$1,111.00</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 11px;">Original Lease</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">CAM</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; background: rgba(255, 235, 59, 0.3);">${cam}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 11px;">${isBeforeAmendment ? 'Original Lease' : 'Amendment 1'}</td>
                                </tr>
                                <tr style="font-weight: bold; background: rgba(34, 197, 94, 0.1);">
                                    <td style="border: 1px solid #ddd; padding: 8px;">TOTAL RENT</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${total}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 11px;">Calculated</td>
                                </tr>
                            </table>
                        </div>

                        <div style="margin-top: 30px; padding: 16px; background: #f8fafc; border-left: 4px solid #3b82f6;">
                            <h4>Amendment History</h4>
                            <ul style="margin-top: 8px;">
                                <li>Original Lease: January 1, 2019 - Base rent $8,500, CAM $2,100</li>
                                ${!isBeforeAmendment ? '<li><strong>Amendment 1: June 1, 2019 - Base rent increased to $10,000, CAM to $4,231.17</strong></li>' : '<li style="color: #94a3b8;">Amendment 1: June 1, 2019 - <em>(not yet effective)</em></li>'}
                            </ul>
                        </div>
                    `
                };
            }
        };

        // Initialize the application
        window.addEventListener('DOMContentLoaded', () => {
            try {
                // Primary initialization - use legacy first
                setupEventListeners();
                updateConformedTab();
                loadDocument('conformed'); // Load initial document
                
                // Then wire modular enhancements
                wireFullView();
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Failed to initialize app:', error);
            }
        });

        // v2.1.0: Full View functionality
        function getActiveTabMeta() {
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) return null;
            
            const tabType = activeTab.classList.contains('conformed') ? 'conformed' : 'document';
            const result = { tabType };
            
            if (tabType === 'conformed') {
                result.asOf = currentAsOfDate;
            } else {
                result.sha256 = activeTab.dataset.sha256 || 'unknown';
            }
            
            return result;
        }

        function openFullView(tabMeta) {
            if (!tabMeta) tabMeta = getActiveTabMeta();
            if (!tabMeta) return;
            
            fullViewOpen = true;
            
            // Create or show full view overlay
            let overlay = document.getElementById('fullViewOverlay');
            if (!overlay) {
                overlay = createFullViewOverlay();
            }
            
            overlay.style.display = 'flex';
            overlay.classList.remove('hidden');
            
            // Set aria-pressed on expand button
            const expandBtn = document.querySelector('[data-testid="fullview-toggle"]');
            if (expandBtn) {
                expandBtn.setAttribute('aria-pressed', 'true');
            }
            
            // Populate content based on tab type
            if (tabMeta.tabType === 'conformed') {
                populateFullViewConformed(overlay, tabMeta.asOf);
            } else {
                populateFullViewDocument(overlay, tabMeta.sha256);
            }
            
            logTelemetry('fullview_opened', {
                tab: tabMeta.tabType,
                as_of: tabMeta.asOf,
                sha256: tabMeta.sha256
            });
        }

        function closeFullView() {
            const overlay = document.getElementById('fullViewOverlay');
            if (!overlay) return;
            
            fullViewOpen = false;
            overlay.style.display = 'none';
            overlay.classList.add('hidden');
            
            logTelemetry('fullview_closed', {
                tab: getActiveTabMeta()?.tabType
            });
        }

        function createFullViewOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'fullViewOverlay';
            overlay.className = 'fullview-overlay hidden';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 2000;
                display: none;
                align-items: center;
                justify-content: center;
            `;
            
            overlay.innerHTML = `
                <div class="fullview-container" style="
                    width: 95%;
                    height: 95%;
                    background: white;
                    border-radius: 8px;
                    display: flex;
                    flex-direction: column;
                    position: relative;
                ">
                    <div class="fullview-header" style="
                        padding: 16px 20px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: between;
                        align-items: center;
                    ">
                        <h2 class="fullview-title">Full View</h2>
                        <button class="fullview-close-btn" data-testid="fullview-close" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #64748b;
                            margin-left: auto;
                        ">&times;</button>
                    </div>
                    <div class="fullview-content" style="
                        flex: 1;
                        overflow: auto;
                        padding: 20px;
                    "></div>
                </div>
            `;
            
            // Add close button handler
            overlay.querySelector('[data-testid="fullview-close"]').addEventListener('click', closeFullView);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeFullView();
            });
            
            document.body.appendChild(overlay);
            return overlay;
        }

        function populateFullViewConformed(overlay, asOf) {
            const title = overlay.querySelector('.fullview-title');
            const content = overlay.querySelector('.fullview-content');
            
            title.textContent = `Full Conformed View (As-Of ${asOf})`;
            
            const isBeforeAmendment = asOf < '2019-06-01';
            const baseRent = isBeforeAmendment ? '$8,500.00' : '$10,000.00';
            const cam = isBeforeAmendment ? '$2,100.00' : '$4,231.17';
            const total = isBeforeAmendment ? '$12,691.00' : '$15,342.17';
            
            content.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; font-family: serif; line-height: 1.6;">
                    <h1 style="text-align: center; margin-bottom: 30px;">CONFORMED LEASE AGREEMENT</h1>
                    <p style="text-align: center; color: #64748b; margin-bottom: 40px;">
                        As of: <strong>${asOf}</strong> | 
                        Status: ${isBeforeAmendment ? 'Original terms in effect' : 'As amended'}
                    </p>
                    
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 20px; border-left: 4px solid #22c55e; margin-bottom: 30px;">
                        <h3>Current Rent Terms</h3>
                        <table style="width: 100%; margin-top: 15px;">
                            <tr><td><strong>Base Rent:</strong></td><td style="text-align: right;"><strong>${baseRent}</strong>/month</td></tr>
                            <tr><td><strong>CAM:</strong></td><td style="text-align: right;"><strong>${cam}</strong>/month</td></tr>
                            <tr><td><strong>Property Taxes:</strong></td><td style="text-align: right;"><strong>$1,111.00</strong>/month</td></tr>
                            <tr style="border-top: 2px solid #22c55e; font-weight: bold;"><td>TOTAL:</td><td style="text-align: right;">${total}/month</td></tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3>Amendment History</h3>
                        <ul>
                            <li><strong>Original Lease:</strong> January 1, 2019 - Base rent $8,500, CAM $2,100</li>
                            ${!isBeforeAmendment ? '<li><strong>Amendment 1:</strong> June 1, 2019 - Base rent increased to $10,000, CAM to $4,231.17</li>' : '<li style="color: #94a3b8;">Amendment 1: June 1, 2019 - <em>(not yet effective as of this date)</em></li>'}
                        </ul>
                    </div>
                </div>
            `;
        }

        function populateFullViewDocument(overlay, sha256) {
            const title = overlay.querySelector('.fullview-title');
            const content = overlay.querySelector('.fullview-content');
            
            title.textContent = `Full Document View - ${sha256.slice(0, 8)}...`;
            
            content.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <h1>Document: ${sha256.slice(0, 8)}...</h1>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p><strong>Full document viewer would be rendered here</strong></p>
                        <p>In production, this would show:</p>
                        <ul>
                            <li>Full PDF.js viewer with all pages</li>
                            <li>Page thumbnails sidebar (optional)</li>
                            <li>Zoom, search, and navigation controls</li>
                            <li>Preserved highlight from evidence chip</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // v2.1.0: Expand current view function
        function expandCurrentView() {
            const tabMeta = getActiveTabMeta();
            if (!tabMeta) return;
            
            if (fullViewOpen) {
                closeFullView();
            } else {
                openFullView(tabMeta);
            }
        }

        // v2.1.0: Wire Full View keyboard shortcuts
        function wireFullView() {
            // Keyboard shortcuts only (button is wired via onclick)
            document.addEventListener('keydown', (e) => {
                // Only handle shortcuts when not in input fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                if (e.key.toLowerCase() === 'f' && !e.metaKey && !e.ctrlKey && !e.altKey) {
                    e.preventDefault();
                    expandCurrentView();
                } else if (e.key === 'Escape') {
                    if (fullViewOpen) {
                        closeFullView();
                    }
                }
            });
        }

        // v2.1.0: Toast notification system
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span>✓</span>
                <span>${message}</span>
            `;
            
            if (type === 'error') {
                toast.style.background = '#ef4444';
                toast.innerHTML = `
                    <span>✗</span>
                    <span>${message}</span>
                `;
            }
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Auto-remove after 2 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Evidence chip interactions
            document.querySelectorAll('.evidence-chip').forEach(chip => {
                chip.addEventListener('click', function(e) {
                    // v2.1.0: Allow Ctrl/Cmd+Click to open new tab
                    if (e.metaKey || e.ctrlKey) {
                        // Don't preventDefault - let browser handle new tab
                        logTelemetry('chip_clicked', {
                            sha256: this.dataset.sha256,
                            page: this.dataset.page,
                            field: this.dataset.field,
                            as_of: currentAsOfDate,
                            with_shift: false,
                            new_tab: true
                        });
                        return;
                    }
                    
                    // Prevent default for all other clicks
                    e.preventDefault();
                    
                    // Log telemetry
                    logTelemetry('chip_clicked', {
                        sha256: this.dataset.sha256,
                        page: this.dataset.page,
                        field: this.dataset.field,
                        as_of: currentAsOfDate,
                        with_shift: e.shiftKey,
                        new_tab: false
                    });
                    
                    if (e.shiftKey) {
                        openSxS(this);
                    } else {
                        // v2.1.0: Use focusEvidence which loads document and highlights
                        focusEvidence(this);
                    }
                });

                // Context menu
                chip.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showContextMenu(e, this);
                });
            });

            // As-of date changes
            document.getElementById('asOfDate').addEventListener('change', function() {
                const oldDate = currentAsOfDate;
                currentAsOfDate = this.value;
                updateConformedTab();
                
                // Log telemetry
                logTelemetry('asof_changed', {
                    from: oldDate,
                    to: this.value
                });
                
                // Always switch to conformed tab and reload with the new date
                switchTab('conformed');
                console.log('As-Of date changed to:', this.value);
            });


            // Chat input
            document.getElementById('chatInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Close context menu on click
            document.addEventListener('click', function() {
                hideContextMenu();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === '[') {
                    prevEvidence();
                } else if (e.key === ']') {
                    nextEvidence();
                } else if (e.key === 'Enter' && selectedEvidence) {
                    if (e.shiftKey) {
                        openSxS(selectedEvidence);
                    } else {
                        focusEvidence(selectedEvidence);
                    }
                }
            });
        }

        function switchTab(tabId) {
            // Update tab appearance
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });

            currentTab = tabId;
            
            // Update document content
            loadDocument(tabId);
        }

        function updateConformedTab() {
            const conformedTab = document.querySelector('.tab.conformed');
            conformedTab.textContent = `Conformed (As-Of ${currentAsOfDate})`;
            
        }


        function focusEvidence(chip) {
            selectedEvidence = chip;
            
            // Remove previous selections
            document.querySelectorAll('.evidence-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');

            const doc = chip.dataset.doc;
            const page = parseInt(chip.dataset.page);
            const bbox = chip.dataset.bbox ? chip.dataset.bbox.split(',').map(Number) : [100, 200, 300, 220];

            // Open the correct tab
            let tabId = 'conformed'; // default
            if (doc.includes('LEASE_2019')) {
                tabId = 'lease2019';
            } else if (doc.includes('AMEND_1')) {
                tabId = 'amend1';
            }
            
            switchTab(tabId);

            // Highlight the evidence
            highlightEvidence(bbox);
            
            // Flash highlight effect
            setTimeout(() => {
                const highlights = document.querySelectorAll('.highlight-overlay');
                highlights.forEach(h => h.classList.add('flash'));
                setTimeout(() => {
                    highlights.forEach(h => h.classList.remove('flash'));
                }, 600);
            }, 100);
        }

        function highlightEvidence(bbox) {
            // Remove existing highlights
            document.querySelectorAll('.highlight-overlay').forEach(h => h.remove());

            // Wait a moment for document to load, then find and highlight the relevant text
            setTimeout(() => {
                const documentContainer = document.querySelector('.document-page');
                if (!documentContainer) return;

                // Find elements with highlighted background (our target content)
                const highlightTargets = documentContainer.querySelectorAll('[style*="background: rgba(255, 235, 59"]');
                
                if (highlightTargets.length > 0) {
                    // Use the first highlighted element as our target
                    const target = highlightTargets[0];
                    const rect = target.getBoundingClientRect();
                    const containerRect = documentContainer.getBoundingClientRect();
                    
                    // Create highlight overlay positioned relative to the target element
                    const highlight = document.createElement('div');
                    highlight.className = 'highlight-overlay flash';
                    highlight.setAttribute('data-testid', 'highlight-span');
                    highlight.style.position = 'absolute';
                    highlight.style.left = (target.offsetLeft - 5) + 'px';
                    highlight.style.top = (target.offsetTop - 5) + 'px';
                    highlight.style.width = (target.offsetWidth + 10) + 'px';
                    highlight.style.height = (target.offsetHeight + 10) + 'px';
                    highlight.style.background = 'rgba(59, 130, 246, 0.2)';
                    highlight.style.border = '3px solid rgba(59, 130, 246, 0.8)';
                    highlight.style.borderRadius = '4px';
                    highlight.style.pointerEvents = 'none';
                    highlight.style.zIndex = '10';
                    highlight.style.boxShadow = '0 0 0 2px white, 0 0 10px rgba(59, 130, 246, 0.5)';

                    documentContainer.style.position = 'relative';
                    documentContainer.appendChild(highlight);

                    // Scroll to the target element
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Remove flash class after animation
                    setTimeout(() => {
                        highlight.classList.remove('flash');
                    }, 600);
                } else {
                    // Fallback: highlight a default area if no specific target found
                    console.log('No highlight targets found, using fallback positioning');
                }
            }, 200);
        }

        function openSxS(chip) {
            sxsOpen = true;
            document.getElementById('sxsOverlay').style.display = 'flex';
            
            // Set up SxS content based on chip
            const doc = chip.dataset.doc;
            const sha256 = chip.dataset.sha256;
            const rightPaneTitle = document.querySelector('.sxs-pane:last-child .pane-title');
            rightPaneTitle.textContent = doc;
            
            // Update left pane with current as-of date
            const leftPaneSubtitle = document.querySelector('.sxs-pane:first-child .pane-subtitle');
            leftPaneSubtitle.textContent = `Current state with amendments`;
            
            // Log telemetry
            logTelemetry('sxs_opened', {
                left_type: 'conformed',
                left_as_of: currentAsOfDate,
                right_type: 'document',
                sha256: sha256
            });
        }

        function closeSxS() {
            sxsOpen = false;
            document.getElementById('sxsOverlay').style.display = 'none';
        }

        function showContextMenu(event, chip) {
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('hidden');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            
            // Store reference to chip for menu actions
            menu.dataset.chipRef = chip.dataset.doc + '|' + chip.dataset.page + '|' + chip.dataset.bbox;
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.add('hidden');
        }

        function copyDeepLink() {
            const menu = document.getElementById('contextMenu');
            const [doc, page, bbox] = menu.dataset.chipRef.split('|');
            
            // Find the corresponding chip to get its SHA256
            const chip = document.querySelector(`[data-doc="${doc}"][data-page="${page}"][data-bbox="${bbox}"]`);
            const sha256 = chip ? chip.dataset.sha256 : 'unknown';
            const field = chip ? chip.dataset.field : '';
            
            // Generate signed URL with expiration (mock implementation)
            const exp = Math.floor(Date.now() / 1000) + 600; // 10 minutes from now
            const deepLink = `/doc/${sha256}?page=${page}&bbox=${bbox}&field=${field}&asof=${currentAsOfDate}&exp=${exp}&sig=mock_signature`;
            
            navigator.clipboard.writeText(window.location.origin + deepLink);
            
            // Log telemetry
            logTelemetry('deep_link_copied', {
                sha256: sha256,
                page: page,
                field: field
            });
            
            // v2.1.0: Show toast instead of alert
            showToast('Copied ✓');
            hideContextMenu();
        }

        function sendToReview() {
            const menu = document.getElementById('contextMenu');
            const [doc, page, bbox] = menu.dataset.chipRef.split('|');
            
            // Find the corresponding chip to get its details
            const chip = document.querySelector(`[data-doc="${doc}"][data-page="${page}"][data-bbox="${bbox}"]`);
            const sha256 = chip ? chip.dataset.sha256 : 'unknown';
            const field = chip ? chip.dataset.field : '';
            
            // Log telemetry
            logTelemetry('hil_action', {
                action: 'send_to_review',
                field: field,
                sha256: sha256,
                page: page
            });
            
            alert('Evidence sent to HIL review queue');
            hideContextMenu();
        }

        function showEvidence() {
            alert('Evidence details displayed');
            hideContextMenu();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message to chat
            const chatHistory = document.getElementById('chatHistory');
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.innerHTML = `<div class="content">${message}</div>`;
            chatHistory.appendChild(userMessage);

            // Clear input
            input.value = '';

            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // TODO: Send to API and add response
        }

        function loadDocument(tabId) {
            const documentContainer = document.querySelector('.document-page');
            let doc;
            
            if (tabId === 'conformed') {
                // Call the conformed function with current as-of date
                doc = mockDocuments[tabId](currentAsOfDate);
            } else {
                doc = mockDocuments[tabId];
            }
            
            if (doc) {
                // Update document content
                documentContainer.innerHTML = `
                    <div style="padding: 40px; font-family: serif; line-height: 1.6;">
                        ${doc.content}
                    </div>
                `;
                
                console.log('Loaded document:', doc.title);
            } else {
                console.log('Document not found:', tabId);
            }
        }

        // Viewer controls
        let currentZoom = 1.0;
        let evidenceIndex = 0;
        const evidenceChips = document.querySelectorAll('.evidence-chip');

        function zoomIn() { 
            currentZoom = Math.min(currentZoom + 0.2, 3.0);
            applyZoom();
        }
        
        function zoomOut() { 
            currentZoom = Math.max(currentZoom - 0.2, 0.5);
            applyZoom();
        }
        
        function applyZoom() {
            const documentPage = document.querySelector('.document-page');
            if (documentPage) {
                documentPage.style.transform = `scale(${currentZoom})`;
                documentPage.style.transformOrigin = 'top center';
                console.log('Zoom applied:', currentZoom);
            }
        }
        
        function toggleTextLayer() { 
            const documentPage = document.querySelector('.document-page');
            if (documentPage) {
                documentPage.style.opacity = documentPage.style.opacity === '0.7' ? '1' : '0.7';
                console.log('Text layer toggled');
            }
        }
        
        function openFullPDF() { 
            alert('Opening full PDF viewer...');
            console.log('Open full PDF'); 
        }
        
        function findInDoc() { 
            const searchTerm = prompt('Search in document:');
            if (searchTerm) {
                console.log('Searching for:', searchTerm);
                alert(`Searching for: "${searchTerm}"`);
            }
        }
        
        function prevEvidence() { 
            if (evidenceIndex > 0) {
                evidenceIndex--;
                const chip = evidenceChips[evidenceIndex];
                if (chip) {
                    focusEvidence(chip);
                    console.log('Previous evidence:', evidenceIndex);
                }
            }
        }
        
        function nextEvidence() { 
            if (evidenceIndex < evidenceChips.length - 1) {
                evidenceIndex++;
                const chip = evidenceChips[evidenceIndex];
                if (chip) {
                    focusEvidence(chip);
                    console.log('Next evidence:', evidenceIndex);
                }
            }
        }

        // Telemetry logging function
        function logTelemetry(eventName, payload) {
            const telemetryEvent = {
                event: eventName,
                timestamp: new Date().toISOString(),
                as_of: currentAsOfDate,
                session_id: 'mock_session_' + Date.now(),
                version: VERSION,
                ...payload
            };
            
            console.log('Telemetry:', telemetryEvent);
            
            // In production, this would send to your analytics service
            // fetch('/api/telemetry', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(telemetryEvent)
            // });
        }
    </script>
</body>
</html>